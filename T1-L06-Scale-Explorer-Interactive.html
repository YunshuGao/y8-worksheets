<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scale Explorer — From Container to Countertop</title>
  <style>
    /* =========================================
       CSS VARIABLES & RESET
       ========================================= */
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --primary-light: #dbeafe;
      --accent: #f97316;
      --accent-dark: #ea580c;
      --accent-light: #fff7ed;
      --success: #22c55e;
      --success-light: #dcfce7;
      --error: #ef4444;
      --error-light: #fee2e2;
      --warning: #eab308;
      --bg: #f1f5f9;
      --card: #ffffff;
      --border: #e2e8f0;
      --text: #0f172a;
      --text-muted: #64748b;
      --text-light: #94a3b8;
      --radius: 12px;
      --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-lg: 0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* =========================================
       HEADER
       ========================================= */
    .header {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: white;
      padding: 1.25rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .header-left h1 { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.025em; }
    .header-left p { font-size: 0.875rem; opacity: 0.9; }
    .header-right {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .header-badge {
      background: rgba(255,255,255,0.2);
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    /* =========================================
       TAB NAVIGATION
       ========================================= */
    .tab-nav {
      display: flex;
      background: var(--card);
      border-bottom: 2px solid var(--border);
      padding: 0;
      overflow-x: auto;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .tab-btn {
      flex: 1;
      min-width: 140px;
      padding: 1rem 1.5rem;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-muted);
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .tab-btn.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      font-weight: 600;
      background: var(--primary-light);
    }
    .tab-btn:hover { color: var(--primary); background: rgba(59,130,246,0.05); }
    .tab-icon { font-size: 1.2rem; }

    /* =========================================
       TAB CONTENT
       ========================================= */
    .tab-content {
      display: none;
      padding: 1.5rem;
      max-width: 960px;
      margin: 0 auto;
      animation: fadeIn 0.3s ease;
    }
    .tab-content.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* =========================================
       CARDS & COMPONENTS
       ========================================= */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-bottom: 1.25rem;
    }
    .card h2 {
      font-size: 1.2rem;
      margin-bottom: 0.75rem;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .card h3 { font-size: 1rem; margin-bottom: 0.5rem; }
    .card p { color: var(--text-muted); margin-bottom: 0.75rem; }

    .callout {
      border-left: 4px solid var(--primary);
      background: var(--primary-light);
      padding: 1rem 1.25rem;
      border-radius: 0 var(--radius) var(--radius) 0;
      margin: 1rem 0;
      font-size: 0.95rem;
    }
    .callout strong { color: var(--primary-dark); }
    .callout.accent {
      border-left-color: var(--accent);
      background: var(--accent-light);
    }
    .callout.accent strong { color: var(--accent-dark); }
    .callout.success {
      border-left-color: var(--success);
      background: var(--success-light);
    }

    /* =========================================
       EXPLORE TAB — VISUAL SCALE DEMO
       ========================================= */
    .scale-presets {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .preset-btn {
      padding: 0.5rem 1rem;
      border: 2px solid var(--border);
      background: var(--card);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    .preset-btn:hover { border-color: var(--primary); color: var(--primary); }
    .preset-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .scale-slider-wrap {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin: 1rem 0;
    }
    .scale-slider-wrap label { font-weight: 600; white-space: nowrap; }
    .scale-slider {
      flex: 1;
      height: 8px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--border);
      border-radius: 4px;
      outline: none;
    }
    .scale-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .scale-display {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      font-family: 'Courier New', monospace;
      min-width: 80px;
      text-align: center;
    }

    .visual-compare {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin: 1.5rem 0;
    }
    .visual-box {
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 240px;
    }
    .visual-box h3 {
      text-align: center;
      margin-bottom: 0.75rem;
      font-size: 0.95rem;
      color: var(--text-muted);
    }
    .visual-box .label-tag {
      font-size: 0.8rem;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-weight: 600;
      margin-bottom: 0.75rem;
    }
    .container-visual-area {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      position: relative;
    }
    .container-rect {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      border-radius: 4px;
      position: relative;
      transition: width 0.4s ease, height 0.4s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.85rem;
      min-width: 4px;
      min-height: 4px;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,0.3);
    }
    .container-rect .dim-label {
      position: absolute;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--accent-dark);
      white-space: nowrap;
      font-family: 'Courier New', monospace;
    }
    .container-rect .dim-top { top: -20px; left: 50%; transform: translateX(-50%); }
    .container-rect .dim-side { right: -70px; top: 50%; transform: translateY(-50%); }

    .dim-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.9rem;
    }
    .dim-table th {
      background: var(--primary-light);
      color: var(--primary-dark);
      padding: 0.5rem 0.75rem;
      text-align: left;
      font-weight: 600;
    }
    .dim-table td {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--border);
      font-family: 'Courier New', monospace;
    }
    .dim-table td:nth-child(3) { color: var(--primary); font-weight: 600; }
    .dim-table .arrow-cell { text-align: center; color: var(--text-light); }

    /* =========================================
       CONCEPT CARDS
       ========================================= */
    .concept-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin: 1rem 0;
    }
    .concept-card {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      text-align: center;
      transition: all 0.2s;
    }
    .concept-card:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .concept-card .emoji { font-size: 2rem; margin-bottom: 0.5rem; }
    .concept-card h4 { font-size: 0.95rem; margin-bottom: 0.25rem; }
    .concept-card p { font-size: 0.8rem; color: var(--text-muted); margin: 0; }

    /* =========================================
       CALCULATOR TAB
       ========================================= */
    .calc-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    .input-group { margin-bottom: 1rem; }
    .input-group label {
      display: block;
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
      color: var(--text-muted);
    }
    .input-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .input-field {
      width: 100%;
      padding: 0.6rem 0.75rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      font-family: 'Courier New', monospace;
      outline: none;
      transition: border-color 0.2s;
    }
    .input-field:focus { border-color: var(--primary); }
    .unit-label {
      font-weight: 600;
      color: var(--text-muted);
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .result-card {
      background: linear-gradient(135deg, var(--primary-light), #eff6ff);
      border: 2px solid var(--primary);
      border-radius: var(--radius);
      padding: 1.25rem;
    }
    .result-card h3 { color: var(--primary-dark); margin-bottom: 0.75rem; }
    .result-row {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      border-bottom: 1px solid rgba(59,130,246,0.2);
    }
    .result-row:last-child { border-bottom: none; }
    .result-label { font-weight: 500; }
    .result-value {
      font-family: 'Courier New', monospace;
      font-weight: 700;
      color: var(--primary-dark);
      font-size: 1.1rem;
    }

    /* A4 Preview */
    .a4-preview-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .a4-paper {
      border: 2px solid #999;
      background: white;
      position: relative;
      box-shadow: 3px 3px 8px rgba(0,0,0,0.15);
    }
    .a4-label {
      position: absolute;
      bottom: -24px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.75rem;
      color: var(--text-muted);
      white-space: nowrap;
    }
    .a4-drawing {
      position: absolute;
      top: 8px;
      left: 8px;
      background: var(--accent);
      opacity: 0.6;
      border-radius: 2px;
      transition: width 0.4s, height 0.4s;
    }
    .a4-drawing.overflow {
      border: 2px dashed var(--error);
      background: rgba(239, 68, 68, 0.2);
    }
    .fits-badge {
      display: inline-block;
      padding: 0.3rem 0.75rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 2rem;
    }
    .fits-badge.yes { background: var(--success-light); color: #15803d; }
    .fits-badge.no { background: var(--error-light); color: #b91c1c; }

    /* =========================================
       PRACTICE TAB — CHALLENGES
       ========================================= */
    .progress-bar-wrap {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.25rem;
    }
    .progress-bar-track {
      flex: 1;
      height: 10px;
      background: var(--border);
      border-radius: 5px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 5px;
      transition: width 0.4s ease;
    }
    .score-display {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--primary);
      white-space: nowrap;
    }

    .level-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .level-1 { background: #dcfce7; color: #15803d; }
    .level-2 { background: #fff7ed; color: #c2410c; }
    .level-3 { background: #fee2e2; color: #b91c1c; }

    .challenge-card {
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      background: var(--card);
    }
    .challenge-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .challenge-question {
      font-size: 1.05rem;
      line-height: 1.7;
      margin-bottom: 1.25rem;
    }
    .challenge-question strong { color: var(--accent-dark); }
    .challenge-question em { color: var(--primary); font-style: normal; font-weight: 600; }

    .answer-area {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .answer-prefix {
      font-weight: 700;
      font-size: 1.1rem;
      font-family: 'Courier New', monospace;
    }
    .answer-input {
      width: 120px;
      padding: 0.6rem 0.75rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1.1rem;
      font-family: 'Courier New', monospace;
      text-align: center;
      outline: none;
      transition: border-color 0.2s;
    }
    .answer-input:focus { border-color: var(--primary); }
    .answer-input.correct { border-color: var(--success); background: var(--success-light); }
    .answer-input.incorrect { border-color: var(--error); background: var(--error-light); }
    .answer-unit {
      font-weight: 600;
      color: var(--text-muted);
      font-size: 1rem;
    }
    .times-symbol {
      font-size: 1.2rem;
      color: var(--text-muted);
    }

    .btn {
      padding: 0.6rem 1.25rem;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: var(--border); color: var(--text-muted); }
    .btn-secondary:hover { background: #cbd5e1; }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #16a34a; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .challenge-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .hint-box {
      display: none;
      background: #fef9c3;
      border-left: 4px solid var(--warning);
      padding: 0.75rem 1rem;
      border-radius: 0 8px 8px 0;
      margin-top: 1rem;
      font-size: 0.9rem;
    }
    .hint-box.visible { display: block; }

    .feedback-box {
      display: none;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      font-size: 0.95rem;
      font-weight: 500;
    }
    .feedback-box.visible { display: block; }
    .feedback-box.correct { background: var(--success-light); color: #15803d; border: 1px solid #86efac; }
    .feedback-box.incorrect { background: var(--error-light); color: #b91c1c; border: 1px solid #fca5a5; }

    .challenge-nav {
      display: flex;
      justify-content: space-between;
      margin-top: 1.5rem;
    }

    .celebration {
      text-align: center;
      padding: 2rem;
    }
    .celebration .big-emoji { font-size: 4rem; margin-bottom: 1rem; }
    .celebration h2 { font-size: 1.5rem; color: var(--primary); margin-bottom: 0.5rem; }
    .celebration p { color: var(--text-muted); font-size: 1.1rem; }

    /* =========================================
       MODEL TAB
       ========================================= */
    .model-comparison {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 1rem;
      align-items: center;
      margin: 1rem 0;
    }
    .model-box {
      text-align: center;
      padding: 1.25rem;
      border-radius: var(--radius);
    }
    .model-box.real { background: var(--accent-light); border: 2px solid var(--accent); }
    .model-box.model { background: var(--primary-light); border: 2px solid var(--primary); }
    .model-box h4 { margin-bottom: 0.5rem; }
    .model-box .dim {
      font-family: 'Courier New', monospace;
      font-size: 1.1rem;
      font-weight: 700;
    }
    .arrow-between {
      font-size: 2rem;
      color: var(--text-light);
      text-align: center;
    }

    .equip-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .equip-table th {
      background: var(--primary-light);
      color: var(--primary-dark);
      padding: 0.6rem 0.75rem;
      text-align: left;
      font-weight: 600;
    }
    .equip-table td {
      padding: 0.6rem 0.75rem;
      border-bottom: 1px solid var(--border);
    }
    .equip-table td.mono {
      font-family: 'Courier New', monospace;
      font-weight: 600;
    }
    .equip-table tr:hover { background: #f8fafc; }

    .custom-calc {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 1rem;
      align-items: end;
      margin: 1rem 0;
    }
    .custom-result {
      font-family: 'Courier New', monospace;
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--primary);
      text-align: center;
      padding: 0.6rem;
      background: var(--primary-light);
      border-radius: 8px;
    }

    /* Floor Plan Grid */
    .floor-plan-section { margin-top: 1.5rem; }
    .floor-plan-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }
    .floor-plan-grid {
      position: relative;
      border: 3px solid var(--text);
      background: white;
    }
    .grid-line-h, .grid-line-v {
      position: absolute;
      background: #e2e8f0;
    }
    .grid-line-major { background: #94a3b8; }
    .grid-ruler-h, .grid-ruler-v {
      position: absolute;
      font-size: 0.6rem;
      color: var(--text-muted);
      font-family: 'Courier New', monospace;
    }

    /* =========================================
       FOOTER
       ========================================= */
    .footer {
      background: var(--card);
      border-top: 2px solid var(--border);
      padding: 1rem 2rem;
      margin-top: 2rem;
    }
    .footer h4 { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; }
    .success-criteria-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      list-style: none;
    }
    .success-criteria-list li {
      background: var(--primary-light);
      color: var(--primary-dark);
      padding: 0.3rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    /* =========================================
       RESPONSIVE
       ========================================= */
    /* =========================================
       STUDENT BAR & SHARE SYSTEM
       ========================================= */
    .student-bar {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 0.6rem 2rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .student-bar label { font-weight: 600; font-size: 0.85rem; color: var(--text-muted); }
    .student-input {
      padding: 0.4rem 0.6rem;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-size: 0.9rem;
      width: 180px;
      outline: none;
      transition: border-color 0.2s;
    }
    .student-input:focus { border-color: var(--primary); }
    .save-btn {
      margin-left: auto;
      padding: 0.5rem 1.25rem;
      background: var(--success);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .save-btn:hover { background: #16a34a; }

    .share-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .share-overlay.visible { display: flex; }
    .share-modal {
      background: var(--card);
      border-radius: var(--radius);
      padding: 2rem;
      max-width: 560px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: fadeIn 0.3s ease;
    }
    .share-modal h3 { font-size: 1.2rem; margin-bottom: 0.5rem; }
    .share-modal p { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem; }
    .share-link-box {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .share-link-input {
      flex: 1;
      padding: 0.6rem 0.75rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 0.8rem;
      font-family: 'Courier New', monospace;
      background: #f8fafc;
      color: var(--text);
      outline: none;
    }
    .copy-btn {
      padding: 0.6rem 1rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.2s;
    }
    .copy-btn:hover { background: var(--primary-dark); }
    .copy-btn.copied { background: var(--success); }
    .share-close {
      margin-top: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--border);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    .share-close:hover { background: #cbd5e1; }

    .teacher-banner {
      display: none;
      background: linear-gradient(135deg, #7c3aed, #6d28d9);
      color: white;
      padding: 1rem 2rem;
    }
    .teacher-banner.visible { display: block; }
    .teacher-banner h3 { font-size: 1.1rem; margin-bottom: 0.25rem; }
    .teacher-banner .meta { opacity: 0.9; font-size: 0.85rem; }
    .teacher-banner .score-summary {
      display: inline-block;
      background: rgba(255,255,255,0.2);
      padding: 0.3rem 0.75rem;
      border-radius: 20px;
      font-weight: 600;
      margin-top: 0.5rem;
    }

    .auto-save-indicator {
      font-size: 0.75rem;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .auto-save-indicator.saved { color: var(--success); }

    @media (max-width: 768px) {
      .header { padding: 1rem; }
      .header-left h1 { font-size: 1.25rem; }
      .tab-btn { min-width: 100px; padding: 0.75rem 0.75rem; font-size: 0.85rem; }
      .tab-content { padding: 1rem; }
      .visual-compare { grid-template-columns: 1fr; }
      .calc-grid { grid-template-columns: 1fr; }
      .concept-grid { grid-template-columns: 1fr; }
      .model-comparison { grid-template-columns: 1fr; }
      .arrow-between { transform: rotate(90deg); }
      .custom-calc { grid-template-columns: 1fr; }
      .student-bar { padding: 0.5rem 1rem; }
      .student-input { width: 140px; }
    }
  </style>
</head>
<body>

  <!-- =========================================
       HEADER
       ========================================= -->
  <header class="header">
    <div class="header-left">
      <h1>Scale Explorer</h1>
      <p>From Container to Countertop &mdash; Year 8 Technology</p>
    </div>
    <div class="header-right">
      <span class="header-badge">T1-L06</span>
      <span class="header-badge">TE4-DES-01</span>
      <span class="header-badge">TE4-MSC-01</span>
    </div>
  </header>

  <!-- =========================================
       TEACHER VIEW BANNER (shown when loading shared link)
       ========================================= -->
  <div class="teacher-banner" id="teacherBanner">
    <h3 id="teacherStudentName">Viewing: Student Name</h3>
    <div class="meta" id="teacherMeta">Class: 8TECI &bull; Submitted: --</div>
    <div class="score-summary" id="teacherScore">Score: -- / 10</div>
  </div>

  <!-- =========================================
       STUDENT INFO BAR
       ========================================= -->
  <div class="student-bar" id="studentBar">
    <label>Name:</label>
    <input class="student-input" id="studentName" placeholder="Your full name" autocomplete="name">
    <label>Class:</label>
    <input class="student-input" id="studentClass" placeholder="e.g. 8TECI" style="width:100px;" autocomplete="off">
    <span class="auto-save-indicator" id="autoSaveStatus"></span>
    <button class="save-btn" onclick="openSharePanel()">&#128279; Save &amp; Get Link</button>
  </div>

  <!-- =========================================
       SHARE MODAL
       ========================================= -->
  <div class="share-overlay" id="shareOverlay" onclick="if(event.target===this)closeSharePanel()">
    <div class="share-modal">
      <h3>&#128279; Your Work Link</h3>
      <p>Copy this link and paste it into <strong>Google Classroom</strong> (or email it to your teacher). Your teacher can open it to see all your work!</p>
      <div class="share-link-box">
        <input class="share-link-input" id="shareLink" readonly onclick="this.select()">
        <button class="copy-btn" id="copyBtn" onclick="copyShareLink()">Copy Link</button>
      </div>
      <p style="font-size:0.8rem; color:var(--text-light);">This link contains all your answers and progress. It works on any device.</p>
      <button class="share-close" onclick="closeSharePanel()">Close</button>
    </div>
  </div>

  <!-- =========================================
       TAB NAVIGATION
       ========================================= -->
  <nav class="tab-nav">
    <button class="tab-btn active" data-tab="explore">
      <span class="tab-icon">&#128270;</span> Explore
    </button>
    <button class="tab-btn" data-tab="calculate">
      <span class="tab-icon">&#129518;</span> Calculate
    </button>
    <button class="tab-btn" data-tab="practice">
      <span class="tab-icon">&#127919;</span> Practice
    </button>
    <button class="tab-btn" data-tab="model">
      <span class="tab-icon">&#128230;</span> My Model
    </button>
  </nav>

  <!-- =========================================
       TAB 1: EXPLORE — Visual Scale Demo
       ========================================= -->
  <section id="tab-explore" class="tab-content active">
    <div class="card">
      <h2>What is Scale?</h2>
      <p>In design and architecture, we often need to draw things <strong>smaller</strong> than they really are so they fit on paper. A <strong>scale</strong> is the ratio between the drawing size and the real-life size.</p>

      <div class="concept-grid">
        <div class="concept-card">
          <div class="emoji">&#128207;</div>
          <h4>Scale Down</h4>
          <p><strong>1 : 20</strong> means the drawing is <strong>20 times smaller</strong> than real life</p>
        </div>
        <div class="concept-card">
          <div class="emoji">&#128208;</div>
          <h4>Full Size</h4>
          <p><strong>1 : 1</strong> means the drawing is the <strong>same size</strong> as real life</p>
        </div>
        <div class="concept-card">
          <div class="emoji">&#128269;</div>
          <h4>Scale Up</h4>
          <p><strong>2 : 1</strong> means the drawing is <strong>2 times bigger</strong> than real life</p>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>See Scale in Action</h2>
      <p>Move the slider to change the scale and watch the shipping container drawing shrink. The <strong>real container</strong> stays the same size — only the <strong>drawing</strong> changes.</p>

      <div class="scale-presets">
        <button class="preset-btn" data-scale="1">1:1</button>
        <button class="preset-btn" data-scale="2">1:2</button>
        <button class="preset-btn" data-scale="5">1:5</button>
        <button class="preset-btn" data-scale="10">1:10</button>
        <button class="preset-btn active" data-scale="20">1:20</button>
        <button class="preset-btn" data-scale="50">1:50</button>
        <button class="preset-btn" data-scale="100">1:100</button>
      </div>

      <div class="scale-slider-wrap">
        <label>Scale 1 :</label>
        <input type="range" class="scale-slider" id="exploreSlider" min="1" max="100" value="20" step="1">
        <div class="scale-display" id="exploreScaleDisplay">1:20</div>
      </div>

      <div class="visual-compare">
        <div class="visual-box">
          <h3>Real Shipping Container</h3>
          <span class="label-tag" style="background: var(--accent-light); color: var(--accent-dark);">Always 6m &times; 2.4m</span>
          <div class="container-visual-area">
            <div class="container-rect" id="realContainer" style="width:300px; height:120px;">
              <span class="dim-label dim-top">6.0 m</span>
              <span class="dim-label dim-side">2.4 m</span>
            </div>
          </div>
        </div>
        <div class="visual-box">
          <h3>Your Scale Drawing</h3>
          <span class="label-tag" id="drawingTag" style="background: var(--primary-light); color: var(--primary-dark);">30 cm &times; 12 cm</span>
          <div class="container-visual-area">
            <div class="container-rect" id="drawingContainer" style="width:15px; height:6px; opacity: 0.8;">
              <span class="dim-label dim-top" id="drawDimTop">30 cm</span>
              <span class="dim-label dim-side" id="drawDimSide">12 cm</span>
            </div>
          </div>
        </div>
      </div>

      <table class="dim-table">
        <thead>
          <tr>
            <th>Dimension</th>
            <th>Real Size</th>
            <th class="arrow-cell"></th>
            <th>Drawing Size</th>
          </tr>
        </thead>
        <tbody id="dimTableBody">
          <!-- Filled by JS -->
        </tbody>
      </table>
    </div>

    <div class="callout accent">
      <strong>Key Formula:</strong> Drawing size = Real size &divide; Scale factor<br>
      For example, at <strong>1:20</strong>, a real length of <strong>600 cm</strong> becomes 600 &divide; 20 = <strong>30 cm</strong> on your drawing.
    </div>

    <div class="callout">
      <strong>Why 1:20?</strong> Your container restaurant model is at <strong>1:20 scale</strong> because it makes a 6-metre container fit neatly as a 30 cm model &mdash; about the length of a school ruler! This is small enough to work on your desk but large enough to add interior details.
    </div>
  </section>

  <!-- =========================================
       TAB 2: CALCULATE — Scale Calculator
       ========================================= -->
  <section id="tab-calculate" class="tab-content">
    <div class="card">
      <h2>Scale Calculator</h2>
      <p>Enter any real-world dimensions and a scale to instantly see the drawing size. The A4 paper preview shows whether your drawing will fit!</p>
    </div>

    <div class="calc-grid">
      <div class="card">
        <h3>Enter Real-World Dimensions</h3>
        <div class="input-group">
          <label>Length</label>
          <div class="input-row">
            <input type="number" class="input-field" id="calcLength" value="600" min="0" step="any">
            <span class="unit-label">cm</span>
          </div>
        </div>
        <div class="input-group">
          <label>Width</label>
          <div class="input-row">
            <input type="number" class="input-field" id="calcWidth" value="240" min="0" step="any">
            <span class="unit-label">cm</span>
          </div>
        </div>
        <div class="input-group">
          <label>Height</label>
          <div class="input-row">
            <input type="number" class="input-field" id="calcHeight" value="240" min="0" step="any">
            <span class="unit-label">cm</span>
          </div>
        </div>
        <div class="input-group">
          <label>Scale &mdash; 1 :</label>
          <div class="input-row">
            <input type="number" class="input-field" id="calcScale" value="20" min="1" step="1">
          </div>
        </div>

        <div style="margin-top:1rem;">
          <p style="font-size:0.85rem; font-weight:600; color:var(--text-muted); margin-bottom:0.5rem;">Quick Presets:</p>
          <div class="scale-presets">
            <button class="preset-btn" onclick="setCalcPreset(600,240,240,20)">Shipping Container 1:20</button>
            <button class="preset-btn" onclick="setCalcPreset(350,250,300,50)">Classroom 1:50</button>
            <button class="preset-btn" onclick="setCalcPreset(1200,600,300,100)">House 1:100</button>
          </div>
        </div>

        <div class="result-card" style="margin-top:1rem;">
          <h3>Drawing Dimensions</h3>
          <div class="result-row">
            <span class="result-label">Length</span>
            <span class="result-value" id="resultLength">30.0 cm</span>
          </div>
          <div class="result-row">
            <span class="result-label">Width</span>
            <span class="result-value" id="resultWidth">12.0 cm</span>
          </div>
          <div class="result-row">
            <span class="result-label">Height</span>
            <span class="result-value" id="resultHeight">12.0 cm</span>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>A4 Paper Preview</h3>
        <p style="font-size:0.85rem;">Does your drawing fit on an A4 page (landscape)?</p>
        <div class="a4-preview-wrap">
          <div class="a4-paper" id="a4Paper" style="width:297px; height:210px; margin-top:1rem;">
            <div class="a4-drawing" id="a4Drawing"></div>
            <span class="a4-label">A4 Landscape (29.7 cm &times; 21 cm)</span>
          </div>
          <div id="fitsBadge" class="fits-badge yes">Fits on A4!</div>
        </div>

        <div class="callout" style="margin-top:2.5rem;">
          <strong>Tip:</strong> If the drawing doesn't fit on A4, try a <strong>larger scale number</strong> (e.g., change 1:10 to 1:20 or 1:50). A bigger denominator = a smaller drawing.
        </div>
      </div>
    </div>
  </section>

  <!-- =========================================
       TAB 3: PRACTICE — Challenges
       ========================================= -->
  <section id="tab-practice" class="tab-content">
    <div class="card">
      <h2>Test Your Skills</h2>
      <p>Work through 10 challenges to master scale calculations. They get progressively harder!</p>

      <div class="progress-bar-wrap">
        <div class="progress-bar-track">
          <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div class="score-display" id="scoreDisplay">0 / 10</div>
      </div>
    </div>

    <div id="challengeArea">
      <!-- Dynamically generated challenge cards -->
    </div>

    <div id="celebrationArea" class="card celebration" style="display:none;">
      <div class="big-emoji">&#127881;</div>
      <h2 id="celebrationTitle">Well Done!</h2>
      <p id="celebrationMsg">You've completed all the challenges.</p>
      <br>
      <button class="btn btn-primary" onclick="resetChallenges()">Try Again</button>
    </div>
  </section>

  <!-- =========================================
       TAB 4: MY MODEL — Container Restaurant Planner
       ========================================= -->
  <section id="tab-model" class="tab-content">
    <div class="card">
      <h2>Your Container Restaurant at 1:20 Scale</h2>
      <p>Use this tool to plan the dimensions of your cardboard model. Every measurement is converted for you!</p>

      <div class="model-comparison">
        <div class="model-box real">
          <h4>Real Container</h4>
          <div class="dim">6.0 m &times; 2.4 m &times; 2.4 m</div>
          <p style="font-size:0.8rem; margin:0.25rem 0 0;">(Length &times; Width &times; Height)</p>
        </div>
        <div class="arrow-between">&xrarr;<br><span style="font-size:0.85rem;">1:20</span></div>
        <div class="model-box model">
          <h4>Your Model</h4>
          <div class="dim">30 cm &times; 12 cm &times; 12 cm</div>
          <p style="font-size:0.8rem; margin:0.25rem 0 0;">(Length &times; Width &times; Height)</p>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Equipment Dimension Guide</h2>
      <p>Here are common restaurant equipment items with their real-life and model sizes at <strong>1:20</strong> scale.</p>

      <table class="equip-table">
        <thead>
          <tr>
            <th>Equipment</th>
            <th>Real Size (L &times; W)</th>
            <th>Model Size (L &times; W)</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="equipTableBody">
          <!-- Filled by JS -->
        </tbody>
      </table>
    </div>

    <div class="card">
      <h2>Custom Dimension Converter</h2>
      <p>Got a different item? Enter its real-life dimensions below.</p>

      <div class="custom-calc">
        <div>
          <div class="input-group">
            <label>Real Length (cm)</label>
            <input type="number" class="input-field" id="customRealL" value="100" min="0" step="any">
          </div>
          <div class="input-group">
            <label>Real Width (cm)</label>
            <input type="number" class="input-field" id="customRealW" value="60" min="0" step="any">
          </div>
        </div>
        <div class="arrow-between" style="font-size:1.5rem; align-self:center;">&xrarr;<br><span style="font-size:0.75rem;">&divide; 20</span></div>
        <div>
          <div class="input-group">
            <label>Model Length</label>
            <div class="custom-result" id="customModelL">5.0 cm</div>
          </div>
          <div class="input-group">
            <label>Model Width</label>
            <div class="custom-result" id="customModelW">3.0 cm</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card floor-plan-section">
      <h2>Floor Plan Grid (Top View)</h2>
      <p>This grid shows your 30 cm &times; 12 cm model from above. Each small square = 1 cm on the model (20 cm in real life). Major lines every 5 cm (1 metre in real life).</p>
      <div class="floor-plan-wrap">
        <div class="floor-plan-grid" id="floorPlanGrid">
          <!-- SVG grid drawn by JS -->
        </div>
      </div>
      <div class="callout accent" style="margin-top:1rem;">
        <strong>Use this grid</strong> to plan where your equipment will go. Measure the model dimensions from the table above and sketch them onto the grid!
      </div>
    </div>

    <div class="callout success">
      <strong>Model Building Tips:</strong><br>
      &bull; Use a sharp blade and cutting mat for clean edges<br>
      &bull; Score fold lines lightly before folding<br>
      &bull; Measure twice, cut once!<br>
      &bull; Use the ruler markings on the grid above to plan your layout before cutting
    </div>
  </section>

  <!-- =========================================
       FOOTER
       ========================================= -->
  <footer class="footer">
    <h4>Success Criteria &mdash; I can...</h4>
    <ul class="success-criteria-list">
      <li>Understand the purpose of scale drawing</li>
      <li>Scale up an object according to a given scale</li>
      <li>Scale down an object according to a given scale</li>
      <li>Choose a suitable scale for a drawing</li>
    </ul>
  </footer>

  <!-- =========================================
       JAVASCRIPT
       ========================================= -->
  <script>
    /* =========================================
       1. CHALLENGE DATA
       ========================================= */
    const challenges = [
      {
        id: 1, level: 1,
        question: 'A shipping container is <strong>6 metres</strong> long. Using a scale of <strong>1:20</strong>, how long would you draw it?',
        hint: 'First convert 6 m to cm (multiply by 100 to get 600 cm), then divide by the scale factor (20).',
        answer: [30], unit: 'cm',
        explanation: '6 m = 600 cm &rarr; 600 &divide; 20 = <strong>30 cm</strong>'
      },
      {
        id: 2, level: 1,
        question: 'The container is <strong>2.4 metres</strong> wide. At <strong>1:20</strong> scale, how wide is the model?',
        hint: 'Convert 2.4 m to cm (= 240 cm), then divide by 20.',
        answer: [12], unit: 'cm',
        explanation: '2.4 m = 240 cm &rarr; 240 &divide; 20 = <strong>12 cm</strong>'
      },
      {
        id: 3, level: 1,
        question: 'A door is <strong>200 cm</strong> tall. At <strong>1:10</strong> scale, how tall is the drawing?',
        hint: 'Divide the real height (200) by the scale factor (10).',
        answer: [20], unit: 'cm',
        explanation: '200 &divide; 10 = <strong>20 cm</strong>'
      },
      {
        id: 4, level: 2,
        question: 'A serving window is <strong>80 cm</strong> wide. At <strong>1:20</strong> scale, how wide would it be on the model?',
        hint: 'Divide 80 by 20.',
        answer: [4], unit: 'cm',
        explanation: '80 &divide; 20 = <strong>4 cm</strong>'
      },
      {
        id: 5, level: 2,
        question: 'A kitchen bench is <strong>1.8 metres</strong> long. At <strong>1:20</strong> scale, what is the model length?',
        hint: 'Convert to cm first: 1.8 m = 180 cm. Then divide by 20.',
        answer: [9], unit: 'cm',
        explanation: '1.8 m = 180 cm &rarr; 180 &divide; 20 = <strong>9 cm</strong>'
      },
      {
        id: 6, level: 2, twoInputs: true,
        question: 'A burger grill measures <strong>90 cm &times; 60 cm</strong> in real life. At <strong>1:20</strong> scale, what are <em>both</em> model dimensions?',
        hint: 'Divide each dimension by 20 separately. 90 &divide; 20 = ? and 60 &divide; 20 = ?',
        answer: [4.5, 3], unit: 'cm',
        explanation: '90 &divide; 20 = <strong>4.5 cm</strong> and 60 &divide; 20 = <strong>3 cm</strong>'
      },
      {
        id: 7, level: 2,
        question: 'On your model, a shelf is <strong>3 cm</strong> long. At <strong>1:20</strong> scale, what is the <em>real-life</em> shelf length?',
        hint: 'To find real size from model size, <strong>multiply</strong> by the scale factor (20).',
        answer: [60], unit: 'cm',
        explanation: '3 &times; 20 = <strong>60 cm</strong>'
      },
      {
        id: 8, level: 2,
        question: 'Your model counter is <strong>7.5 cm</strong> long. At <strong>1:20</strong> scale, what is the real counter length?',
        hint: 'Multiply model size by scale factor: 7.5 &times; 20 = ?',
        answer: [150], unit: 'cm',
        explanation: '7.5 &times; 20 = <strong>150 cm</strong> (or 1.5 m)'
      },
      {
        id: 9, level: 3, findScale: true,
        question: 'A table is <strong>120 cm</strong> in real life and <strong>6 cm</strong> on the drawing. What scale was used?',
        hint: 'Divide the real size by the drawing size: 120 &divide; 6 = ?',
        answer: [20], unit: '',
        explanation: '120 &divide; 6 = <strong>20</strong>, so the scale is <strong>1 : 20</strong>'
      },
      {
        id: 10, level: 3, findScale: true,
        question: 'A building is <strong>50 metres</strong> tall and <strong>5 cm</strong> on a drawing. What scale was used?',
        hint: 'Convert to the same unit first! 50 m = 5000 cm. Then divide: 5000 &divide; 5 = ?',
        answer: [1000], unit: '',
        explanation: '50 m = 5000 cm &rarr; 5000 &divide; 5 = <strong>1000</strong>, so the scale is <strong>1 : 1000</strong>'
      }
    ];

    /* =========================================
       2. EQUIPMENT DATA
       ========================================= */
    const equipment = [
      { name: 'Burger Grill / Flat Top', realL: 90, realW: 60, notes: 'Main cooking surface' },
      { name: 'Kitchen Bench / Counter', realL: 180, realW: 60, notes: 'Prep & serving area' },
      { name: 'Sink (Single)', realL: 50, realW: 40, notes: 'Handwashing & cleaning' },
      { name: 'Upright Fridge', realL: 60, realW: 60, notes: 'Ingredient storage' },
      { name: 'Storage Shelf Unit', realL: 90, realW: 45, notes: 'Dry goods & supplies' },
      { name: 'Serving Window', realL: 100, realW: 10, notes: 'Customer-facing opening' },
      { name: 'Entry Door', realL: 80, realW: 10, notes: 'Staff access' },
      { name: 'Deep Fryer', realL: 40, realW: 40, notes: 'For chips / fried items' },
      { name: 'Cash Register Area', realL: 60, realW: 50, notes: 'Payment & order taking' },
      { name: 'Stool / Bar Seat', realL: 35, realW: 35, notes: 'Optional customer seating' },
    ];

    /* =========================================
       3. STATE
       ========================================= */
    const state = {
      exploreScale: 20,
      currentChallenge: 0,
      score: 0,
      answered: new Array(challenges.length).fill(false),
      correct: new Array(challenges.length).fill(false),
    };

    /* =========================================
       4. TAB SWITCHING
       ========================================= */
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
      });
    });

    /* =========================================
       5. EXPLORE TAB
       ========================================= */
    const exploreSlider = document.getElementById('exploreSlider');
    const exploreScaleDisplay = document.getElementById('exploreScaleDisplay');
    const drawingContainer = document.getElementById('drawingContainer');
    const drawDimTop = document.getElementById('drawDimTop');
    const drawDimSide = document.getElementById('drawDimSide');
    const drawingTag = document.getElementById('drawingTag');
    const dimTableBody = document.getElementById('dimTableBody');

    const REAL_L = 600; // cm
    const REAL_W = 240;
    const REAL_H = 240;
    const MAX_VIS_W = 300; // px for real container visual
    const MAX_VIS_H = 120;

    function updateExplore() {
      const s = state.exploreScale;
      exploreScaleDisplay.textContent = '1:' + s;

      // Update preset buttons
      document.querySelectorAll('.preset-btn[data-scale]').forEach(b => {
        b.classList.toggle('active', parseInt(b.dataset.scale) === s);
      });

      // Drawing dimensions
      const drawL = REAL_L / s;
      const drawW = REAL_W / s;
      const drawH = REAL_H / s;

      // Visual sizing (proportional to real container visual)
      const visW = Math.max(4, MAX_VIS_W / s);
      const visH = Math.max(4, MAX_VIS_H / s);

      drawingContainer.style.width = visW + 'px';
      drawingContainer.style.height = visH + 'px';

      // Labels
      const fmtL = drawL >= 100 ? (drawL / 100).toFixed(1) + ' m' : drawL.toFixed(1) + ' cm';
      const fmtW = drawW >= 100 ? (drawW / 100).toFixed(1) + ' m' : drawW.toFixed(1) + ' cm';
      const fmtH = drawH >= 100 ? (drawH / 100).toFixed(1) + ' m' : drawH.toFixed(1) + ' cm';

      drawDimTop.textContent = fmtL;
      drawDimSide.textContent = fmtH;

      // Hide labels if too small
      drawDimTop.style.display = visW < 30 ? 'none' : '';
      drawDimSide.style.display = visH < 20 ? 'none' : '';

      drawingTag.innerHTML = fmtL + ' &times; ' + fmtW;

      // Dimension table
      dimTableBody.innerHTML = [
        { name: 'Length', real: REAL_L, draw: drawL },
        { name: 'Width', real: REAL_W, draw: drawW },
        { name: 'Height', real: REAL_H, draw: drawH },
      ].map(d => {
        const realFmt = d.real >= 100 ? (d.real / 100).toFixed(1) + ' m' : d.real + ' cm';
        const drawFmt = d.draw >= 100 ? (d.draw / 100).toFixed(1) + ' m' : d.draw.toFixed(1) + ' cm';
        return `<tr>
          <td>${d.name}</td>
          <td>${realFmt}</td>
          <td class="arrow-cell">&divide; ${s} &rarr;</td>
          <td>${drawFmt}</td>
        </tr>`;
      }).join('');
    }

    exploreSlider.addEventListener('input', () => {
      state.exploreScale = parseInt(exploreSlider.value);
      updateExplore();
    });

    document.querySelectorAll('.preset-btn[data-scale]').forEach(btn => {
      btn.addEventListener('click', () => {
        state.exploreScale = parseInt(btn.dataset.scale);
        exploreSlider.value = state.exploreScale;
        updateExplore();
      });
    });

    /* =========================================
       6. CALCULATOR TAB
       ========================================= */
    const calcInputs = ['calcLength', 'calcWidth', 'calcHeight', 'calcScale'];

    function updateCalculator() {
      const L = parseFloat(document.getElementById('calcLength').value) || 0;
      const W = parseFloat(document.getElementById('calcWidth').value) || 0;
      const H = parseFloat(document.getElementById('calcHeight').value) || 0;
      const S = parseFloat(document.getElementById('calcScale').value) || 1;

      const dL = L / S;
      const dW = W / S;
      const dH = H / S;

      const fmt = v => v >= 100 ? (v / 100).toFixed(2) + ' m' : v.toFixed(1) + ' cm';

      document.getElementById('resultLength').textContent = fmt(dL);
      document.getElementById('resultWidth').textContent = fmt(dW);
      document.getElementById('resultHeight').textContent = fmt(dH);

      // A4 preview (landscape: 297mm x 210mm)
      // We display A4 at 1px = 1mm
      const a4W = 297;
      const a4H = 210;
      const drawingEl = document.getElementById('a4Drawing');
      const fitsBadge = document.getElementById('fitsBadge');

      // Drawing dimensions in mm (cm * 10)
      const drawMmL = dL * 10;
      const drawMmW = dW * 10;

      // Clamp visual size to prevent overflow of the preview area
      const visDrawW = Math.min(drawMmL, 500);
      const visDrawH = Math.min(drawMmW, 400);

      drawingEl.style.width = visDrawW + 'px';
      drawingEl.style.height = visDrawH + 'px';

      const fits = drawMmL <= a4W && drawMmW <= a4H;
      drawingEl.classList.toggle('overflow', !fits);

      fitsBadge.textContent = fits ? 'Fits on A4!' : 'Too big for A4!';
      fitsBadge.className = 'fits-badge ' + (fits ? 'yes' : 'no');
    }

    function setCalcPreset(l, w, h, s) {
      document.getElementById('calcLength').value = l;
      document.getElementById('calcWidth').value = w;
      document.getElementById('calcHeight').value = h;
      document.getElementById('calcScale').value = s;
      updateCalculator();
    }

    calcInputs.forEach(id => {
      document.getElementById(id).addEventListener('input', updateCalculator);
    });

    /* =========================================
       7. PRACTICE TAB — CHALLENGE SYSTEM
       ========================================= */
    const challengeArea = document.getElementById('challengeArea');
    const progressFill = document.getElementById('progressFill');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const celebrationArea = document.getElementById('celebrationArea');

    function renderChallenge() {
      const i = state.currentChallenge;
      if (i >= challenges.length) {
        showCelebration();
        return;
      }

      const c = challenges[i];
      const levelLabel = ['', 'Basic', 'Intermediate', 'Advanced'][c.level];
      const isAnswered = state.answered[i];
      const isCorrect = state.correct[i];

      let inputHtml = '';
      if (c.findScale) {
        inputHtml = `
          <span class="answer-prefix">1 :</span>
          <input type="number" class="answer-input ${isAnswered ? (isCorrect ? 'correct' : 'incorrect') : ''}"
                 id="answer1" ${isAnswered ? 'disabled' : ''} step="any"
                 onkeydown="if(event.key==='Enter')checkAnswer()">
        `;
      } else if (c.twoInputs) {
        inputHtml = `
          <input type="number" class="answer-input ${isAnswered ? (isCorrect ? 'correct' : 'incorrect') : ''}"
                 id="answer1" placeholder="L" ${isAnswered ? 'disabled' : ''} step="any"
                 onkeydown="if(event.key==='Enter')document.getElementById('answer2').focus()">
          <span class="times-symbol">&times;</span>
          <input type="number" class="answer-input ${isAnswered ? (isCorrect ? 'correct' : 'incorrect') : ''}"
                 id="answer2" placeholder="W" ${isAnswered ? 'disabled' : ''} step="any"
                 onkeydown="if(event.key==='Enter')checkAnswer()">
          <span class="answer-unit">${c.unit}</span>
        `;
      } else {
        inputHtml = `
          <input type="number" class="answer-input ${isAnswered ? (isCorrect ? 'correct' : 'incorrect') : ''}"
                 id="answer1" ${isAnswered ? 'disabled' : ''} step="any"
                 onkeydown="if(event.key==='Enter')checkAnswer()">
          <span class="answer-unit">${c.unit}</span>
        `;
      }

      challengeArea.innerHTML = `
        <div class="challenge-card">
          <div class="challenge-header">
            <span>Question ${i + 1} of ${challenges.length}</span>
            <span class="level-badge level-${c.level}">${levelLabel}</span>
          </div>
          <div class="challenge-question">${c.question}</div>
          <div class="answer-area">
            <span style="font-weight:600; margin-right:0.25rem;">Answer:</span>
            ${inputHtml}
          </div>
          <div class="challenge-actions">
            ${!isAnswered ? '<button class="btn btn-primary" onclick="checkAnswer()">Check</button>' : ''}
            <button class="btn btn-secondary" onclick="toggleHint()">Hint</button>
          </div>
          <div class="hint-box" id="hintBox">${c.hint}</div>
          <div class="feedback-box ${isAnswered ? 'visible' : ''} ${isAnswered ? (isCorrect ? 'correct' : 'incorrect') : ''}" id="feedbackBox">
            ${isAnswered ? (isCorrect ? '&#9989; Correct! ' : '&#10060; Not quite. ') + c.explanation : ''}
          </div>
          <div class="challenge-nav">
            <button class="btn btn-secondary" onclick="navChallenge(-1)" ${i === 0 ? 'disabled' : ''}>&#8592; Previous</button>
            <button class="btn btn-${isAnswered ? 'success' : 'secondary'}" onclick="navChallenge(1)">
              ${i < challenges.length - 1 ? 'Next &#8594;' : 'Finish &#127881;'}
            </button>
          </div>
        </div>
      `;

      celebrationArea.style.display = 'none';
      updateProgress();

      if (!isAnswered) {
        setTimeout(() => {
          const firstInput = document.getElementById('answer1');
          if (firstInput) firstInput.focus();
        }, 100);
      }
    }

    function checkAnswer() {
      const i = state.currentChallenge;
      const c = challenges[i];
      if (state.answered[i]) return;

      const val1 = parseFloat(document.getElementById('answer1').value);
      let isCorrect = false;

      if (c.twoInputs) {
        const val2 = parseFloat(document.getElementById('answer2').value);
        isCorrect = Math.abs(val1 - c.answer[0]) < 0.5 && Math.abs(val2 - c.answer[1]) < 0.5;
      } else {
        isCorrect = Math.abs(val1 - c.answer[0]) < 0.5;
      }

      state.answered[i] = true;
      state.correct[i] = isCorrect;
      if (isCorrect) state.score++;

      renderChallenge();
    }

    function toggleHint() {
      const hintBox = document.getElementById('hintBox');
      hintBox.classList.toggle('visible');
    }

    function navChallenge(dir) {
      state.currentChallenge = Math.max(0, Math.min(challenges.length, state.currentChallenge + dir));
      if (state.currentChallenge >= challenges.length) {
        showCelebration();
      } else {
        renderChallenge();
      }
    }

    function updateProgress() {
      const answered = state.answered.filter(Boolean).length;
      progressFill.style.width = (answered / challenges.length * 100) + '%';
      scoreDisplay.textContent = state.score + ' / ' + challenges.length;
    }

    function showCelebration() {
      challengeArea.innerHTML = '';
      celebrationArea.style.display = 'block';
      const pct = Math.round(state.score / challenges.length * 100);
      const title = document.getElementById('celebrationTitle');
      const msg = document.getElementById('celebrationMsg');

      if (pct === 100) {
        title.textContent = 'Perfect Score!';
        msg.textContent = 'You got every question right! You really understand scale.';
      } else if (pct >= 70) {
        title.textContent = 'Great Job!';
        msg.textContent = `You scored ${state.score} out of ${challenges.length}. Strong understanding of scale!`;
      } else if (pct >= 40) {
        title.textContent = 'Good Effort!';
        msg.textContent = `You scored ${state.score} out of ${challenges.length}. Keep practising — you're getting there!`;
      } else {
        title.textContent = 'Keep Practising!';
        msg.textContent = `You scored ${state.score} out of ${challenges.length}. Review the Explore tab and try again.`;
      }
      updateProgress();
    }

    function resetChallenges() {
      state.currentChallenge = 0;
      state.score = 0;
      state.answered.fill(false);
      state.correct.fill(false);
      renderChallenge();
    }

    /* =========================================
       8. MODEL TAB
       ========================================= */
    function renderEquipmentTable() {
      const tbody = document.getElementById('equipTableBody');
      tbody.innerHTML = equipment.map(e => {
        const mL = (e.realL / 20).toFixed(1);
        const mW = (e.realW / 20).toFixed(1);
        return `<tr>
          <td><strong>${e.name}</strong></td>
          <td class="mono">${e.realL} &times; ${e.realW} cm</td>
          <td class="mono" style="color:var(--primary);">${mL} &times; ${mW} cm</td>
          <td style="font-size:0.85rem; color:var(--text-muted);">${e.notes}</td>
        </tr>`;
      }).join('');
    }

    function updateCustomCalc() {
      const rL = parseFloat(document.getElementById('customRealL').value) || 0;
      const rW = parseFloat(document.getElementById('customRealW').value) || 0;
      document.getElementById('customModelL').textContent = (rL / 20).toFixed(1) + ' cm';
      document.getElementById('customModelW').textContent = (rW / 20).toFixed(1) + ' cm';
    }

    document.getElementById('customRealL').addEventListener('input', updateCustomCalc);
    document.getElementById('customRealW').addEventListener('input', updateCustomCalc);

    function renderFloorPlanGrid() {
      const container = document.getElementById('floorPlanGrid');
      const gridW = 600; // 30cm at 20px per cm
      const gridH = 240; // 12cm at 20px per cm
      const pxPerCm = 20;

      container.style.width = gridW + 'px';
      container.style.height = gridH + 'px';

      let svg = `<svg width="${gridW}" height="${gridH}" xmlns="http://www.w3.org/2000/svg">`;

      // Minor grid lines (every 1cm = 20px)
      for (let x = pxPerCm; x < gridW; x += pxPerCm) {
        const isMajor = (x % (pxPerCm * 5)) === 0;
        svg += `<line x1="${x}" y1="0" x2="${x}" y2="${gridH}"
                  stroke="${isMajor ? '#94a3b8' : '#e2e8f0'}"
                  stroke-width="${isMajor ? 1.5 : 0.5}"/>`;
      }
      for (let y = pxPerCm; y < gridH; y += pxPerCm) {
        const isMajor = (y % (pxPerCm * 5)) === 0;
        svg += `<line x1="0" y1="${y}" x2="${gridW}" y2="${y}"
                  stroke="${isMajor ? '#94a3b8' : '#e2e8f0'}"
                  stroke-width="${isMajor ? 1.5 : 0.5}"/>`;
      }

      // Ruler labels (every 5cm along top)
      for (let x = 0; x <= 30; x += 5) {
        svg += `<text x="${x * pxPerCm + 2}" y="-4" font-size="11" fill="#64748b"
                  font-family="monospace">${x}cm</text>`;
      }
      // Ruler labels (every 5cm along left, rotated text not ideal in SVG, use right side)
      for (let y = 0; y <= 12; y += 5) {
        if (y > 0 && y < 12) {
          svg += `<text x="${gridW + 4}" y="${y * pxPerCm + 4}" font-size="11" fill="#64748b"
                    font-family="monospace">${y}cm</text>`;
        }
      }

      svg += '</svg>';

      // Add ruler labels above and to the right using HTML
      container.innerHTML = svg;
      container.style.position = 'relative';
      container.style.overflow = 'visible';

      // Top ruler
      for (let x = 0; x <= 30; x += 5) {
        const label = document.createElement('span');
        label.className = 'grid-ruler-h';
        label.style.cssText = `position:absolute; top:-18px; left:${x * pxPerCm - 8}px; font-size:0.7rem; color:#64748b; font-family:monospace;`;
        label.textContent = x + 'cm';
        if (x === 0) label.textContent = '0';
        container.appendChild(label);
      }

      // Real-life labels
      const realLabel = document.createElement('div');
      realLabel.style.cssText = 'text-align:center; margin-top:8px; font-size:0.8rem; color:var(--text-muted);';
      realLabel.innerHTML = '30 cm on model = 6 m in real life &nbsp; | &nbsp; 12 cm on model = 2.4 m in real life';
      container.parentElement.appendChild(realLabel);
    }

    /* =========================================
       9. SAVE / SHARE / LOAD SYSTEM
       ========================================= */
    const STORAGE_KEY = 'scaleExplorer_progress';

    function getStudentData() {
      const answers = [];
      for (let i = 0; i < challenges.length; i++) {
        const inputEl = document.getElementById('answer1_stored_' + i);
        // We store answers from the state
        answers.push(state.answered[i] ? (challenges[i].twoInputs ? state.storedAnswers?.[i] || [] : state.storedAnswers?.[i] || null) : null);
      }
      return {
        name: document.getElementById('studentName').value.trim(),
        cls: document.getElementById('studentClass').value.trim(),
        answers: state.storedAnswers || [],
        answered: state.answered,
        correct: state.correct,
        score: state.score,
        ts: new Date().toISOString()
      };
    }

    function serializeState() {
      const data = getStudentData();
      try {
        return btoa(unescape(encodeURIComponent(JSON.stringify(data))));
      } catch (e) {
        return btoa(JSON.stringify(data));
      }
    }

    function deserializeState(encoded) {
      try {
        const json = decodeURIComponent(escape(atob(encoded)));
        return JSON.parse(json);
      } catch (e) {
        try { return JSON.parse(atob(encoded)); }
        catch (e2) { return null; }
      }
    }

    function openSharePanel() {
      const name = document.getElementById('studentName').value.trim();
      if (!name) {
        document.getElementById('studentName').style.borderColor = 'var(--error)';
        document.getElementById('studentName').focus();
        document.getElementById('studentName').placeholder = 'Please enter your name first!';
        setTimeout(() => {
          document.getElementById('studentName').style.borderColor = '';
          document.getElementById('studentName').placeholder = 'Your full name';
        }, 3000);
        return;
      }

      const encoded = serializeState();
      const baseUrl = window.location.href.split('#')[0].split('?')[0];
      const shareUrl = baseUrl + '?work=' + encoded;

      document.getElementById('shareLink').value = shareUrl;
      document.getElementById('shareOverlay').classList.add('visible');
      document.getElementById('copyBtn').textContent = 'Copy Link';
      document.getElementById('copyBtn').classList.remove('copied');
    }

    function closeSharePanel() {
      document.getElementById('shareOverlay').classList.remove('visible');
    }

    function copyShareLink() {
      const linkInput = document.getElementById('shareLink');
      linkInput.select();
      navigator.clipboard.writeText(linkInput.value).then(() => {
        const btn = document.getElementById('copyBtn');
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'Copy Link';
          btn.classList.remove('copied');
        }, 2500);
      }).catch(() => {
        // Fallback for older browsers
        document.execCommand('copy');
        document.getElementById('copyBtn').textContent = 'Copied!';
      });
    }

    function saveToLocalStorage() {
      const data = getStudentData();
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e) {}
      showAutoSave();
    }

    function showAutoSave() {
      const indicator = document.getElementById('autoSaveStatus');
      indicator.textContent = 'Auto-saved';
      indicator.classList.add('saved');
      setTimeout(() => {
        indicator.textContent = '';
        indicator.classList.remove('saved');
      }, 2000);
    }

    function loadFromLocalStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) return JSON.parse(raw);
      } catch(e) {}
      return null;
    }

    function loadFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const encoded = params.get('work');
      if (encoded) return deserializeState(encoded);
      return null;
    }

    function applyLoadedData(data, isTeacherView) {
      if (!data) return;

      if (data.name) document.getElementById('studentName').value = data.name;
      if (data.cls) document.getElementById('studentClass').value = data.cls;

      if (data.answered) {
        state.answered = data.answered;
        state.correct = data.correct || new Array(challenges.length).fill(false);
        state.score = data.score || 0;
        state.storedAnswers = data.answers || [];
      }

      if (isTeacherView) {
        document.getElementById('teacherBanner').classList.add('visible');
        document.getElementById('teacherStudentName').textContent = 'Viewing: ' + (data.name || 'Unknown Student');
        const dateStr = data.ts ? new Date(data.ts).toLocaleString('en-AU', { dateStyle: 'medium', timeStyle: 'short' }) : '--';
        document.getElementById('teacherMeta').textContent = 'Class: ' + (data.cls || '--') + '  •  Submitted: ' + dateStr;
        document.getElementById('teacherScore').textContent = 'Practice Score: ' + (data.score || 0) + ' / ' + challenges.length;
        // Hide student bar in teacher view
        document.getElementById('studentBar').style.display = 'none';
      }
    }

    // Store answers when checking (hook into existing checkAnswer)
    const originalCheckAnswer = checkAnswer;
    checkAnswer = function() {
      const i = state.currentChallenge;
      const val1 = parseFloat(document.getElementById('answer1')?.value);
      const val2 = document.getElementById('answer2') ? parseFloat(document.getElementById('answer2').value) : null;

      if (!state.storedAnswers) state.storedAnswers = [];
      state.storedAnswers[i] = val2 !== null ? [val1, val2] : val1;

      originalCheckAnswer();
      saveToLocalStorage();
    };

    // Auto-save when student name/class changes
    document.getElementById('studentName').addEventListener('change', saveToLocalStorage);
    document.getElementById('studentClass').addEventListener('change', saveToLocalStorage);

    /* =========================================
       10. INITIALISATION
       ========================================= */
    // Check for URL data first (teacher view), then localStorage (student returning)
    const urlData = loadFromUrl();
    const localData = loadFromLocalStorage();

    if (urlData) {
      applyLoadedData(urlData, true);
    } else if (localData) {
      applyLoadedData(localData, false);
    }

    updateExplore();
    updateCalculator();
    renderChallenge();
    renderEquipmentTable();
    updateCustomCalc();
    renderFloorPlanGrid();
  </script>
</body>
</html>
